<!-- map.component.html -->
<div id="map" style="height:100vh;width:100vw;"></div>

<!-- panneaux overlay -->
<app-routes-panel (newRoute)="openNewRoute()" (centerRoute)="centerRoute($event)"></app-routes-panel>
<app-trains-panel (center)="centerOn($event)" (newTrain)="openNewTrainPanel()"></app-trains-panel>

<!-- Légende -->
<div class="legend-card">
  <div class="legend-row"><span class="dot dot-green"></span> Feu vert (OK)</div>
  <div class="legend-row"><span class="dot dot-yellow"></span> Avertissement</div>
  <div class="legend-row"><span class="dot dot-red"></span> Incident / Danger</div>
</div>

<!-- Filtre -->
<div class="filter-card">
  <label class="toggle">
    <input type="checkbox" [(ngModel)]="showAlertsOnly" (change)="applyFilter()">
    <span>Afficher <b>alertes uniquement</b></span>
  </label>
</div>

<!-- Modal création de train -->
@if (newTrainOpen) {
  <div class="modal-card">
    <div class="modal-head">
      <div class="modal-title">Nouveau train</div>
    </div>

    <label class="lbl">Identifiant</label>
    <input [(ngModel)]="nt_trainId" class="inp">

    <label class="lbl">Route</label>
    <select [(ngModel)]="nt_routeId" class="inp">
      <option *ngFor="let r of routes" [value]="r.id">{{ r.id }}</option>
    </select>

    <div class="grid2">
      <div>
        <label class="lbl">Vitesse (km/h)</label>
        <input type="number" [(ngModel)]="nt_lineSpeedKmh" min="1" class="inp">
      </div>
      <div>
        <label class="lbl">Seg. départ</label>
        <input type="number" [(ngModel)]="nt_startSeg" min="0" class="inp">
      </div>
      <div>
        <label class="lbl">Progress (0..1)</label>
        <input type="number" [(ngModel)]="nt_startProgress" min="0" max="1" step="0.01" class="inp">
      </div>
    </div>

    <div class="btns">
      <button (click)="cancelNewTrainPanel()" class="btn">Annuler</button>
      <button (click)="submitNewTrain()" class="btn primary">Créer</button>
    </div>
  </div>
}

<!-- Outil de tracé de route -->
@if (recording) {
  <div class="draw-card">
    <div class="title">Tracer une route</div>
    <label class="lbl">Id de route</label>
    <input [(ngModel)]="newRouteId" class="inp">
    <div class="hint">Clique sur la carte pour ajouter des points le long d’une voie.</div>
    <div class="btns">
      <button (click)="cancelNewRoute()" class="btn">Annuler</button>
      <button (click)="saveNewRoute()" class="btn primary" [disabled]="recorded.length < 2">Enregistrer</button>
    </div>
  </div>
}

<style>
/* Cartes flottantes */
.legend-card{
  position:fixed; bottom:16px; left:16px; z-index:1000;
  background:#fff; padding:10px 12px; border-radius:12px;
  box-shadow:0 6px 18px rgba(0,0,0,.15); font-family:system-ui; font-size:14px;
}
.legend-row{ display:flex; align-items:center; gap:8px; margin:4px 0; }
.dot{ width:12px; height:12px; border-radius:50%; display:inline-block; box-shadow:0 0 0 2px #fff, 0 0 0 4px rgba(0,0,0,.1);}
.dot-green{  background:#10b981; }
.dot-yellow{ background:#f59e0b; }
.dot-red{    background:#ef4444; }

.filter-card{
  position:fixed; bottom:16px; right:16px; z-index:1000;
  background:#fff; padding:10px 12px; border-radius:12px;
  box-shadow:0 6px 18px rgba(0,0,0,.15); font-family:system-ui; font-size:14px;
}
.toggle input{ margin-right:8px; }

/* Modale nouveau train (panneau) */
.modal-card{
  position:fixed; top:80px; right:16px; z-index:1300;
  background:#fff; padding:12px; border-radius:12px;
  box-shadow:0 6px 18px rgba(0,0,0,.15); font-family:system-ui; width:300px;
}
.modal-head{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.modal-title{ font-weight:700; font-size:18px; }
.lbl{ display:block; font-size:12px; color:#444; margin:8px 0 4px; }
.inp{ width:100%; padding:6px 8px; border:1px solid #ddd; border-radius:8px; }
.grid2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px; }
.btns{ display:flex; gap:8px; margin-top:12px; }
.btn{ padding:6px 10px; border-radius:10px; border:1px solid #ddd; background:#f8f9ff; cursor:pointer; }
.btn.primary{ background:#2563eb; border-color:#2563eb; color:#fff; }

/* Carte d’édition de route (draw) */
.draw-card{
  position:fixed; top:80px; left:16px; z-index:1300;
  background:#fff; padding:10px 12px; border-radius:12px;
  box-shadow:0 6px 18px rgba(0,0,0,.15); font-family:system-ui; width:260px;
}
.draw-card .title{ font-weight:600; margin-bottom:6px; }
.draw-card .hint{ font-size:12px; color:#666; margin:8px 0; }

/* Tooltips (Leaflet) colorés */
.leaflet-tooltip.tt-green{ background:#10b981; border-color:#0a8f6c; color:#fff; }
.leaflet-tooltip.tt-yellow{ background:#f59e0b; border-color:#b26f07; color:#fff; }
.leaflet-tooltip.tt-red{ background:#ef4444; border-color:#b91c1c; color:#fff; }
.leaflet-tooltip.tt-green .leaflet-tooltip-tip{ background:#10b981; border-top-color:#0a8f6c; }
.leaflet-tooltip.tt-yellow .leaflet-tooltip-tip{ background:#f59e0b; border-top-color:#b26f07; }
.leaflet-tooltip.tt-red .leaflet-tooltip-tip{ background:#ef4444; border-top-color:#b91c1c; }
</style>
